# Implementation Plan

- [ ] 1. 登録済み推し一覧取得サービスを実装する
- [x] 1.1 登録済み推しを取得し表示用データへ正規化する
  - movie_oshiを起点にmovieを結合して登録済みのみ取得する
  - 必須項目が欠損している行は除外する
  - isOshiは常にtrueとして返却する
  - RLSによりログインユーザーの範囲に限定される前提で取得する
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 1.2 取得失敗時のエラー種別を正規化する
  - supabase未設定時はnot_configuredとして扱う
  - 通信失敗と未知エラーを識別して返却する
  - 失敗時は一覧データを返さない
  - _Requirements: 4.2, 4.3_

- [ ] 2. 推し登録サービスの整合性を確保する
- [x] 2.1 推し登録/解除のトグルでユーザー紐づけと重複防止を行う
  - movieIdの欠損や形式不正は即時に無効入力として返す
  - 登録時はログインユーザーIDとmovieIdを保存する
  - 既存登録がある場合は重複を防止する
  - 失敗時は理由を識別できる結果を返す
  - _Requirements: 1.1, 1.3, 1.4, 3.4_

- [x] 2.2 作品一覧取得時に推し初期状態を反映する
  - 認証済みユーザーの登録状況を取得してisOshiに反映する
  - 未登録の作品はisOshiをfalseとして扱う
  - 取得失敗時は適切なエラーとして返す
  - _Requirements: 3.3_

- [ ] 3. 推しリストページの取得・表示フローを実装する
- [x] 3.1 認証判定後にのみ一覧取得を開始し未認証時は誘導する
  - 認証状態を確認して未認証ならログイン画面へ遷移する
  - 未認証時は一覧取得を開始しない
  - _Requirements: 2.3_

- [x] 3.2 読み込み/エラー/空/一覧の状態を排他的に表示する
  - 取得開始時に読み込み表示へ切り替える
  - 取得成功時は登録済みのみ一覧表示する
  - 0件の場合は空状態を表示する
  - 取得失敗時はエラー表示を出し一覧を表示しない
  - _Requirements: 2.1, 2.2, 2.4, 4.1, 4.2, 4.3_

- [x] 3.3 表示形式の切替で一覧データを維持する
  - 表示形式の切替操作で表示モードのみ変更する
  - 切替後も取得済み一覧を保持して再描画する
  - _Requirements: 8.1, 8.2_

- [ ] 4. 推し登録UIの状態反映と通知を実装する
- [ ] 4.1 推しボタンの初期状態を登録済みで表示する
  - 取得済みのisOshiを用いて初期状態を設定する
  - 登録済みの表示が常に反映されるようにする
  - _Requirements: 3.3_

- [ ] 4.2 推し登録成功時に状態と一覧へ反映する
  - 登録成功後に推し状態が即時に表示へ反映される
  - 推し一覧の表示にも対象が追加される
  - _Requirements: 3.1, 3.2_

- [ ] 4.3 推し登録失敗時に失敗通知を表示する
  - 登録失敗時は失敗した旨をユーザーへ通知する
  - 失敗時は表示状態の更新を抑止する
  - _Requirements: 3.4_

- [ ] 4.4 未認証時は登録処理を行わずログインへ誘導する
  - 未認証の場合は推し登録処理を開始しない
  - ログイン画面へ誘導して登録操作を中断する
  - _Requirements: 1.2_

- [ ] 5. テストで主要フローを検証する
- [ ] 5.1 (P) 登録済み推し取得サービスの正規化とエラーを単体で検証する
  - 正常系で登録済みのみ取得できることを確認する
  - 取得データの正規化結果を検証する
  - エラー種別の正規化を検証する
  - _Requirements: 2.1, 2.2, 2.5, 4.2_

- [ ] 5.2 (P) 推し登録サービスの入力検証と重複防止を単体で検証する
  - 無効なmovieIdを拒否することを確認する
  - 重複登録の防止が機能することを確認する
  - 失敗時の結果が適切に返ることを確認する
  - _Requirements: 1.1, 1.3, 1.4, 3.4_

- [ ] 5.3 (P) 認証ガードの未認証判定と誘導を検証する
  - 未認証時にログイン誘導が行われることを確認する
  - 認証状態の判定結果が期待通りであることを確認する
  - _Requirements: 1.2, 2.3_

- [ ] 5.4 (P) 推しリストページの状態表示と切替を統合で検証する
  - 読み込み/エラー/空状態の表示が正しいことを確認する
  - 登録済みのみ表示されることを確認する
  - 表示形式の切替後も一覧が維持されることを確認する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 4.1, 4.2, 4.3, 8.1, 8.2_

- [ ] 5.5 (P) 推し登録フローの表示反映を統合で検証する
  - 初期状態が登録済みとして表示されることを確認する
  - 登録成功時に状態と一覧が反映されることを確認する
  - 失敗時に失敗通知が表示されることを確認する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_
