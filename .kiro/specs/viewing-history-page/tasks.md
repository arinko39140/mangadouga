# Implementation Plan

- [ ] 1. 履歴取得と表示用データ整形を行う
- [x] 1.1 閲覧履歴をクリック日時降順で取得し、30件以内に制限して表示用に整形する
  - 本人の履歴に限定して取得し、`clicked_at` を基準に新しい順へ並べる
  - 取得対象は直近30件までとし、古い履歴は表示対象外にするが削除はしない
  - 履歴の `movie` 情報を結合してタイトル・サムネイル・推し数を付与する
  - デフォルトリストのみを参照して推しバッジ表示状態を判定する
  - `movie` 情報が欠損する履歴は表示対象から除外する
  - _Requirements: 1.3, 1.4, 1.5, 1.6, 1.7, 1.9, 1.10, 1.11, 1.12, 1.13, 7.1, 7.2, 7.3_

- [x] 1.2 取得結果のエラー分類と未ログイン時の返却を整備する
  - Supabase未設定、未ログイン、通信失敗の各ケースで適切なエラー区分を返す
  - 取得件数の指定は1-30に正規化し、既定値でも上限を超えないようにする
  - _Requirements: 1.8_

- [ ] 2. 履歴記録を行う共通サービスを実装する
- [x] 2.1 明示操作ごとに履歴を1件記録する
  - `clicked_at` を明示的に設定して履歴を作成する
  - 未ログイン時は記録しないが、画面遷移や操作は継続する
  - 同一動画を繰り返し閲覧した場合も毎回新規履歴として保持する
  - _Requirements: 4.1, 4.5, 4.6, 4.7, 7.3_

- [x] 2.2 多重発火を抑止し、操作単位で1件だけ記録する
  - 300-500msの抑止ウィンドウで同一 `movieId` + `source` の連続発火を抑える
  - 暗黙の初期選択や自動再生では記録しない
  - _Requirements: 4.2, 4.3, 4.6_

- [ ] 3. 閲覧履歴ページのルーティングとUI表示を実装する
- [x] 3.1 閲覧履歴ページへのルートと未ログイン時の誘導を行う
  - `/history/` で履歴ページへアクセスできるようにする
  - 未ログイン時はログイン画面へ誘導し、履歴一覧は表示しない
  - _Requirements: 1.2, 1.8, 5.1, 5.2_

- [x] 3.2 履歴一覧・空状態・トップ導線を表示する
  - 履歴がある場合はタイトル、サムネイル、最終閲覧日時、推しバッジ、推し数を表示する
  - 履歴がない場合は「閲覧履歴がありません」に相当する文言を表示し、一覧は非表示にする
  - 空状態にトップページへの導線を表示する
  - _Requirements: 1.1, 1.3, 1.4, 1.5, 1.9, 1.10, 2.1, 2.2, 2.3, 2.4_

- [x] 3.3 履歴項目から話数ページへ遷移できるようにする
  - 履歴項目選択時に対象の話数ページへ遷移する
  - `seriesId` と `movieId` を用い、`selectedMovieId` を付与して選択済み状態で表示させる
  - 必要な `seriesId` は `movie` の情報から取得する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 4. 動画遷移と履歴記録のトリガーを統合する
- [x] 4.1 動画カード遷移を共通化し、遷移時に履歴を記録する
  - 明示クリック時に履歴記録を行い、その後に遷移する
  - `seriesId` と `movieId` がある場合は `selectedMovieId` を付与して遷移する
  - 記録失敗時も遷移は継続する
  - _Requirements: 3.3, 3.4, 4.1_

- [x] 4.2 主要な一覧/詳細ページの遷移を共通導線に統一する
  - 既存の動画カード遷移を共通導線へ置き換える
  - 明示操作のみで履歴記録が発火するようにする
  - _Requirements: 4.1_

- [x] 4.3 話数切替時の履歴記録を追加する
  - 話数選択の明示操作時のみ履歴を記録する
  - 初期選択やURLパラメータによる自動選択では記録しない
  - _Requirements: 4.2, 4.6_

- [x] 4.4 再生ボタン押下で履歴記録を追加する
  - 再生ボタンの明示操作のみを再生開始として扱い、履歴を記録する
  - _Requirements: 4.3, 4.4_

- [ ] 5. マイページに閲覧履歴導線を追加する
- [x] 5.1 マイページに閲覧履歴ページへのリンクを表示する
  - _Requirements: 6.1_

- [ ] 6. データベースのポリシーとインデックスを整備する
- [x] 6.1 (P) 履歴取得・記録に必要なRLSとインデックス、トリガーを適用する
  - 本人以外の履歴参照・作成を拒否するポリシーに更新する
  - クリック日時の降順取得を支えるインデックスを用意する
  - デフォルトリストを自動作成するトリガーを有効化する
  - _Requirements: 1.12, 1.13, 4.7_

- [ ] 7. 履歴表示と記録のテストを追加する
- [x] 7.1 閲覧履歴取得の並び順と件数制限を検証する
  - `clicked_at` 降順と30件制限、本人履歴のみの取得を確認する
  - _Requirements: 1.6, 1.7, 1.11, 1.12, 1.13, 7.1_

- [x] 7.2 履歴記録の未ログイン時挙動と重複記録を検証する
  - 未ログイン時に記録が行われないことを確認する
  - 同一動画の繰り返し記録が保持されることを確認する
  - _Requirements: 4.5, 4.6, 4.7, 7.3_

- [x] 7.3 閲覧履歴ページの空状態とログイン誘導を検証する
  - 空状態で一覧が表示されないことと導線表示を確認する
  - 未ログイン時にログイン画面へ誘導されることを確認する
  - _Requirements: 1.8, 2.1, 2.2, 2.3, 2.4, 5.1, 5.2_

- [x] 7.4 履歴項目からの遷移と選択状態を検証する
  - `selectedMovieId` 付きで話数ページへ遷移することを確認する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_
