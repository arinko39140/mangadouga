# Implementation Tasks

- [ ] 1. 作品ページの統合状態と初期選択を整える
- [x] 1.1 作品ページの状態モデルと初期データ取得フローを実装する
  - 作品情報と話数一覧の取得状態を分離して管理できるようにする
  - 話数一覧が存在する場合は最新話を初期選択として扱う
  - 話数選択の変更で再生対象の状態を更新できるようにする
  - 並び順の初期値を「最新話」に設定する
  - 話数一覧の更新に合わせて選択状態と総数の整合を保つ
  - _Requirements: 1.2, 2.4, 5.2, 5.3, 7.2_

- [x] 1.2 ログイン復帰時の選択状態と並び順を復元する
  - リダイレクト時のパラメータから話数選択と並び順を復元する
  - 不正な値は既定値へフォールバックする
  - 復元後に一覧の選択状態と再生対象が一致することを確認する
  - _Requirements: 2.4, 5.3_

- [ ] 2. データ取得と認証ガードの基盤を整える
- [x] 2.1 (P) 作品情報と話数一覧の取得を整備する
  - 作品情報と話数一覧を取得し、画面が扱う形式に変換する
  - 「最新話」「古い順」に応じて公開日の並び順を切り替える
  - 公開日未設定の話数は一覧に含め、並び順の末尾に配置する
  - 取得失敗時のエラー種別を正規化して返せるようにする
  - _Requirements: 2.5, 2.6_

- [x] 2.2 (P) お気に入りと推しの更新処理を用意する
  - 認証済みユーザー向けにお気に入り登録の切り替えを行えるようにする
  - 認証済みユーザー向けに推し登録の切り替えを行えるようにする
  - 更新後の状態を返してUIが即時反映できるようにする
  - _Requirements: 4.2, 8.3_

- [x] 2.3 (P) 認証ガードとログイン導線を実装する
  - 認証状態を取得し、未ログイン時はログイン導線へ誘導する
  - ログイン導線には作品ページへ戻るためのリダイレクト情報を含める
  - 認証取得に失敗した場合は未ログイン扱いとする
  - _Requirements: 4.3, 8.4_

- [ ] 3. 作品ヘッダーとお気に入りUIを構築する
- [ ] 3.1 (P) 作品タイトルの表示と読み込み状態を整える
  - 作品タイトルを作品ページ上に表示する
  - 作品情報が取得中の間は読み込み状態を示す
  - _Requirements: 3.1, 3.2_

- [ ] 3.2 (P) お気に入りスターの表示と操作を実装する
  - お気に入り登録状態をスター表示で示す
  - スター操作時に認証ガードを通し、更新結果を即時反映する
  - 登録済み状態が分かる表示を維持する
  - _Requirements: 4.1, 4.2, 4.4_

- [ ] 4. 再生領域の表示を構築する
- [ ] 4.1 (P) 選択話数の再生表示と準備中状態を実装する
  - 選択された話数の動画を再生領域に表示する
  - 話数選択の変更で再生対象を切り替える
  - 再生準備中であることを示す状態を表示する
  - 動画URL未設定時は代替表示で補完する
  - _Requirements: 1.1, 1.3, 1.4, 1.5_

- [ ] 5. 話数一覧の表示と操作を整える
- [ ] 5.1 (P) 話数一覧パネルと総数表示を実装する
  - 話数一覧を表示し、選択中の話数が判別できるようにする
  - 話数の総数を「全N話」の形式で表示する
  - 一覧が空の場合は話数が存在しない状態を表示する
  - 話数一覧の更新に合わせて総数表示を更新する
  - _Requirements: 2.1, 2.7, 5.1, 5.3, 7.1, 7.2_

- [ ] 5.2 (P) 話数カードのメタ情報表示を整える
  - サムネイル、タイトル、公開日を話数ごとに表示する
  - 公開日が未設定の場合は未設定であることを示す
  - サムネイルが欠損している場合はプレースホルダで補完する
  - _Requirements: 2.2, 6.1, 6.2, 6.3, 8.6_

- [ ] 5.3 (P) 話数の並び順切り替えを提供する
  - 「最新話」「古い順」を選択できるUIを用意する
  - 現在の並び順が分かる表示状態を維持する
  - _Requirements: 2.3_

- [ ] 5.4 (P) 推しバッジの表示と操作を実装する
  - 推し登録済み話数は「済」、未登録は「推」を表示する
  - 推し操作時に認証ガードを通し、更新結果を即時反映する
  - 話数一覧上で登録状態を識別できるようにする
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [ ] 6. 統合とテストで要件を検証する
- [ ] 6.1 作品ページ全体の統合配線を完了する
  - 作品情報・話数一覧・再生領域・操作UIの連携を通す
  - 最新話の初期選択と再生表示が連動していることを確認する
  - 並び順変更時に選択状態と再生対象が一致するようにする
  - _Requirements: 1.2, 1.3, 1.4, 2.1, 2.4, 5.2, 5.3, 7.2_

- [ ] 6.2 データ取得と並び順ロジックのユニットテストを追加する
  - 最新話/古い順の並び替え結果を検証する
  - 公開日未設定の話数が末尾に並ぶことを検証する
  - 取得失敗時のエラー正規化を検証する
  - _Requirements: 2.5, 2.6, 6.3_

- [ ] 6.3 作品ページ表示と選択操作の統合テストを追加する
  - 作品ページ初期表示で最新話が選択されることを確認する
  - 話数選択の変更で再生対象が更新されることを確認する
  - 並び順切り替えと空状態表示の挙動を確認する
  - _Requirements: 1.2, 1.3, 1.4, 2.1, 2.3, 2.4, 2.7, 5.1, 5.2, 5.3, 7.1, 7.2_

- [ ] 6.4 お気に入り/推し操作とログイン導線のテストを追加する
  - 未ログイン時にログイン画面へ誘導されることを確認する
  - お気に入り/推しの状態が切り替わることを確認する
  - 一覧上で登録状態が反映されることを確認する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_
