# ギャップ分析（work-page-playback-episode-list）

## 分析サマリー
- 作品ページ（`/series/{seriesId}/`）と話数一覧に対応する既存コンポーネント/ルートは未実装で、UI・データ取得・状態管理が新規で必要。
- Supabaseの既存テーブルは`movie`中心で、話数やシリーズ、推し/お気に入りの永続化に必要なスキーマが不足している。
- 既存コードはデータプロバイダ注入・状態分岐（loading/error/empty）・アクセシビリティ対応のパターンがあり、設計へ転用可能。
- 認証/ログイン誘導は未実装のため、推し/お気に入り操作の要件は仕様解釈と実装方針の整理が必要。

## ドキュメント状況
- 参照: `.kiro/specs/work-page-playback-episode-list/requirements.md`（未承認）
- 参照: `.kiro/steering/` 全ファイル、`.kiro/settings/rules/gap-analysis.md`
- ギャップ分析フレームワークに従って現状調査・要件適合性・選択肢評価を実施

## 1. 現状調査

### 1.1 既存アセット/構成
- ルーティング: `src/AppRouter.jsx` に `/` と `/oshi-lists/` のみ
- UIパターン: `src/TopPage.jsx`（状態分岐、aria、データプロバイダ注入）
- データ取得: `src/weekdayDataProvider.js`（Supabase query + 正規化）
- Supabase: `public.movie` テーブル（`movie_id`, `movie_title`, `url`, `favorite_count`, `update`, `series_id`, `weekday`）
- CSS: コンポーネント単位のCSSファイル（`TopPage.css`、`App.css`）
- テスト: `vitest` + Testing Library（UIの状態/表示/アクセシビリティ検証）

### 1.2 命名/構成パターン
- React function component + CSSクラス命名（`top-page__*`）
- データプロバイダを props 注入しテスト容易性を確保
- 取得失敗/未設定/空の状態を明確に分岐

### 1.3 統合面
- Supabase クライアントは `src/supabaseClient.js` に集約
- 認証・ユーザー関連の実装/テーブルは現状未整備

## 2. 要件適合性とギャップ

### 2.1 要件→アセット対応表（ギャップタグ）

| 要件 | 既存アセット | ギャップ |
| --- | --- | --- |
| 動画再生領域の表示/切替（Req 1/5） | 該当UIなし | Missing |
| 話数一覧の表示/ソート（Req 2） | 該当UIなし | Missing |
| 作品タイトル表示（Req 3） | 該当UIなし | Missing |
| お気に入り（スター）操作（Req 4） | 認証・DBなし | Missing / Unknown |
| 話数メタ情報表示（Req 6） | `movie`に`update`あり | Constraint |
| 話数総数表示（Req 7） | 集計UIなし | Missing |
| 推しバッジ表示・登録（Req 8） | 該当UI/DBなし | Missing / Unknown |

### 2.2 必要な技術要素（不足/未知）
- **UIコンポーネント**: 作品ページ（再生領域 + 話数一覧 + ソート + バッジ）
- **ルーティング**: `/series/:seriesId/` 追加
- **データモデル**:
  - シリーズ（作品）情報（タイトル、メタ）
  - 話数（エピソード）一覧（サムネ・タイトル・公開日・動画URL）
  - 推し/お気に入り状態（ユーザー別）
- **認証/ログイン誘導**:
  - 未ログイン時の遷移設計（`/login/` を前提）
  - 認証基盤が未実装のため要検討
- **再生領域**:
  - 動画プレイヤーの実装方式（埋め込み/リンク/iframe）

### 2.3 制約/既存前提
- 既存は`movie`テーブル中心で「話数」と「作品」の区別が未定義
- Supabase設定未入力時のUIエラー処理が既存と整合させる必要あり
- TypeScriptなし、JS + ESLint前提

### 2.4 Research Needed（設計フェーズへ持ち越し）
- 作品/話数のデータスキーマ設計（`series`/`episode`テーブルの有無）
- 推し/お気に入りのデータ永続化（Supabase auth + 関連テーブル）
- 動画再生方式（YouTube埋め込み/独自プレイヤー/外部リンク）
- 既存`movie`テーブルとの統合方針（移行/拡張/置換）

## 3. 実装アプローチの選択肢

### Option A: 既存コンポーネント拡張
**方針**: `TopPage.jsx` と同様の設計でWorkページを追加。既存`weekdayDataProvider`パターンを再利用してデータ取得ロジックを増設。  
**影響範囲**: `AppRouter.jsx` + 新規ページコンポーネント + 新規データプロバイダ。  
**トレードオフ**:
- ✅ 既存UI/テストパターンを活用
- ✅ 追加コストが小さい
- ❌ 既存の`movie`中心データ構造に強く依存する可能性
- ❌ 認証・推し/お気に入りが曖昧なまま進むリスク

### Option B: 新規ページ/ドメイン分離
**方針**: 作品ページ用の新規コンポーネント群と専用データ層（`seriesDataProvider`, `episodeDataProvider`）を作成。  
**影響範囲**: ルーティング追加 + 新規UI/状態管理 + Supabaseスキーマ拡張。  
**トレードオフ**:
- ✅ 責務分離が明確で拡張性が高い
- ✅ 作品/話数/推しのドメインを整理しやすい
- ❌ ファイル/設計が増える
- ❌ スキーマ設計/移行の検討コストが高い

### Option C: ハイブリッド（UIは新規、データは既存拡張）
**方針**: 作品ページUIは新規作成しつつ、短期は`movie`テーブルの`series_id`活用で話数一覧を暫定構成。  
**影響範囲**: ルーティング追加 + 新規UI + `movie`拡張/運用ルール追加。  
**トレードオフ**:
- ✅ 早期にUIを組み立てやすい
- ✅ データ移行の猶予を確保できる
- ❌ 長期的にはスキーマ再設計が必要になる可能性
- ❌ 一時的な仕様の分岐が増える

## 4. 実装規模・リスク評価

- **Effort**: L（1〜2週間）
  - UI/ルーティング/状態管理に加え、スキーマ検討と認証導線が必要。
- **Risk**: Medium
  - 既存パターンはあるが、データモデルと認証が未整備で不確実性が高い。

## 5. 設計フェーズへの推奨・論点

- **推奨方針（暫定）**: Option C（ハイブリッド）
  - UI/UXの可視化を優先しつつ、データモデルの再設計を後続に回せるため。
- **主要論点**:
  - 作品/話数のテーブル設計と`movie`の位置づけ
  - 推し/お気に入りの状態管理（クライアント保持 vs DB）
  - 動画再生の埋め込み/外部遷移の方針

## 次のステップ

- 要件の承認状態を整理したうえで設計フェーズへ進む  
- `/prompts:kiro-spec-design work-page-playback-episode-list` を実行して design.md を作成  
- 必要に応じてスキーマ設計・認証方針のリサーチを追加で実施
