# Implementation Plan

- [ ] 1. データ層のスキーマ・権限・集計の整備
- [x] 1.1 リスト公開設定と登録数の基盤データを追加して既存データを整合させる
  - 公開フラグと登録数の列を追加し初期値を定義する
  - 既存お気に入り登録から登録数を集計して反映する
  - 並び替えと取得に必要なインデックスを整備する
  - _Requirements: 4.5, 4.6, 4.7, 5.2, 5.3, 6.4, 6.5_

- [x] 1.2 公開/非公開とログイン必須のRLS・ビューを整える
  - 未ログインの取得を拒否し、ログイン必須の一覧/お気に入り取得を保証する
  - 公開リストのみを公開一覧に含めるビューを用意する
  - お気に入りは本人のみ取得・更新できるよう制御する
  - 非公開リストの閲覧と更新を所有者に限定する
  - _Requirements: 1.1, 1.3, 1.5, 4.1, 4.3, 5.4, 5.6_

- [x] 1.3 お気に入り登録数を自動更新するトリガーを実装する
  - お気に入りの登録/解除で登録数が増減するようにする
  - 登録数が負数にならないことを担保する
  - 公開一覧と詳細ページの登録数と整合することを確認する
  - _Requirements: 4.5, 4.6, 4.7, 6.4, 6.5_

- [ ] 2. データプロバイダと更新通知の実装
- [x] 2.1 (P) 公開推しリスト一覧の取得とお気に入りトグルを提供する
  - ログイン必須で一覧取得し、公開リストのみを返す
  - 登録数の並び替え条件を反映し、初期は多い順で取得する
  - お気に入り状態を付与し、トグル結果を最新状態で返す
  - 認証切れ・ネットワーク・未設定のエラー種別を扱う
  - _Requirements: 4.1, 4.2, 4.4, 4.5, 4.6, 4.7, 6.1, 6.4_

- [x] 2.2 (P) 登録済み推しリストの取得とお気に入りトグルを提供する
  - ログインユーザーの登録済みのみを取得し、重複を排除する
  - 非公開に切り替わったリストは取得結果から除外する
  - 無効なリスト指定や認証切れ時は操作を失敗させる
  - _Requirements: 1.3, 1.5, 2.1, 2.2, 2.4, 2.5, 2.6, 3.1, 3.4_

- [x] 2.3 (P) 推しリストの公開/非公開状態の取得と更新を提供する
  - 所有者のみが更新できるようにし、非所有者は拒否する
  - 公開/非公開の状態取得と更新結果を返す
  - 認証切れ・権限不足・ネットワークの失敗を扱う
  - _Requirements: 5.1, 5.2, 5.3, 5.5, 5.6_

- [x] 2.4 (P) 推しリスト更新イベントを配信して一覧を同期する
  - お気に入り登録/解除や公開設定変更後に更新通知を発行する
  - 一覧/詳細/お気に入り一覧が更新通知で再取得できるようにする
  - 多重購読を避け、ページ遷移でリスナーを整理する
  - _Requirements: 3.3, 6.5_

- [ ] 3. ページUIの更新
- [x] 3.1 みんなの推しリスト一覧をログイン必須で表示する
  - 未ログイン時はログインページへ遷移する
  - 登録数の並び替えと初期順序をUIに反映する
  - お気に入り状態と登録数を表示し、トグル操作を反映する
  - 更新通知を受けて一覧を再取得する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 6.1, 6.3, 6.4, 6.5, 2.6_

- [ ] 3.2 お気に入り推しリストを登録済みのみ表示する
  - 未ログイン時はログインページへ遷移する
  - 登録済みのみを表示し、空状態を案内する
  - 登録/解除操作を反映し、認証切れ時は操作を中断する
  - 他ユーザーの登録結果が混在しないことを担保する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3, 3.4_

- [ ] 3.3 推しリスト詳細と公開/非公開切替UIを整合させる
  - 所有者のみ公開/非公開の操作UIを表示する
  - 非公開時は未ログインに内容を表示しない
  - 登録アイコン/登録バッジと登録数を表示して更新通知で同期する
  - 公開状態の取得/更新は認証状態に合わせて制御する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 3.4 トップページにみんなの推しリストへの導線を追加する
  - 既存の導線と整合する形で一覧への遷移手段を用意する
  - 遷移先が正しい一覧ルートになることを確認する
  - _Requirements: 7.1, 7.2_

- [ ] 4. テストで主要フローの品質を確認する
- [ ] 4.1 プロバイダのユニットテストを追加する
  - 一覧取得の並び替え条件が反映されることを確認する
  - お気に入り取得が認証必須で失敗するパスを検証する
  - 公開/非公開更新の権限制御を検証する
  - _Requirements: 1.1, 4.6, 4.7, 5.5, 5.6_

- [ ] 4.2 統合テストで一覧と登録数の整合性を確認する
  - 公開一覧でお気に入り状態が反映されることを確認する
  - 登録/解除で登録数が更新されることを確認する
  - 非公開リストが未ログインに表示されないことを確認する
  - _Requirements: 4.2, 4.4, 4.5, 5.4, 6.5_

- [ ] 4.3 UI/E2Eテストで主要導線を確認する
  - 未ログインでお気に入り一覧にアクセスするとログインへ遷移する
  - 一覧でお気に入りトグルが反映されることを確認する
  - 公開/非公開切替が詳細ページに反映されることを確認する
  - _Requirements: 1.1, 4.4, 5.2, 5.3, 6.5_
