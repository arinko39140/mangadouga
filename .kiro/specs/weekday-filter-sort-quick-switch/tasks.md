# Implementation Plan

- [ ] 1. ソート共通ポリシーと切替UIの基盤を整える
- [x] 1.1 SortOrderPolicyの正規化と既定値を実装する
  - sortOrderをpopular/latestの2値に正規化し、未対応値はpopularへフォールバックさせる
  - URLキー名をsortOrderに統一し、既定値popularを提供する
  - 既存の互換値（favorite_desc/favorite_asc/oldest）をpopularへ変換する
  - _Requirements: 2.3, 3.5, 3.6, 6.1_

- [x] 1.2 「投稿日／人気」切替UIの表示と選択状態を更新する
  - popular/latestの2択のみを扱い、現在選択中の項目を視覚的に区別する
  - 想定外の値はpopularに戻す挙動をUI側でも担保する
  - _Requirements: 2.1, 2.2, 3.2, 3.4_

- [ ] 2. TopPageの曜日クイック切替とソート連動を構築する
- [x] 2.1 曜日タブ/ボタンの選択状態と再選択挙動を実装する
  - 曜日選択で一覧を絞り込み、「すべて」で解除できるようにする
  - 選択中の曜日を判別可能に表示し、同一曜日再選択時は状態を維持する
  - フィルタとソートの選択状態が同時に分かる表示を整える
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 4.3_

- [x] 2.2 既定表示とソート維持のルールをTopPageに反映する
  - 初期表示は当日の曜日＋人気を既定とし、再読み込みでも同条件で復元する
  - 曜日変更時に選択中のソート基準を維持し、フィルタ結果へ並び替えを適用する
  - sortOrderの意味を統一し、TopPageのURLへ同期更新する
  - _Requirements: 3.2, 3.5, 3.6, 4.1, 4.2, 6.2, 6.3_

- [x] 2.3 空状態と一覧更新の整合性を担保する
  - 条件に一致する項目がない場合は空状態を明示する
  - フィルタ/ソート切替時に一覧の整合性を保って更新する
  - 操作中は直前に選択された条件が反映された結果を表示する
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 3. TopPage向け曜日カタログ取得を実装する
- [ ] 3.1 曜日フィルタと最新100件の取得ルールを組み込む
  - 曜日指定時はweekdayで絞り込み、allの場合は曜日条件を外す
  - movie.updateがnullの行を除外し、update降順で最新100件を確定する
  - 「投稿日」はmovie.updateとして扱い、最新100件はupdate降順で判定する
  - _Requirements: 1.5, 1.6, 1.7, 2.1, 2.5_

- [ ] 3.2 人気順の並び替えと件数制限の順序を保証する
  - 最新100件を確定した後にfavorite_countで人気順へ並び替える
  - 人気順の同値はmovie.update降順で解消し、常に100件以内を保つ
  - 人気の基準はlist_movie件数と一致させる
  - _Requirements: 2.2, 2.6, 4.1_

- [ ] 4. WorkPageのソート連動と取得ロジックを統合する
- [ ] 4.1 (P) WorkPageでsortOrderの統一とUI切替を反映する
  - sortOrderの値を共通ポリシーで正規化し、URLに同期する
  - 「投稿日／人気」の切替が一覧に反映されるよう連携する
  - 未対応のソート値はpopularへフォールバックする
  - _Requirements: 2.1, 2.2, 2.3, 3.4, 3.5, 3.6_

- [ ] 4.2 (P) WorkPageの人気/投稿日ソート取得とページングを実装する
  - popularはfavorite_count降順、同値はupdate降順で並び替える
  - latestはmovie.update降順で並び替える
  - 50件単位のページング取得で無制限件数にも対応する
  - _Requirements: 2.1, 2.2, 2.4, 2.5, 2.6, 3.4_

- [ ] 5. みんなの推しリスト一覧の人気ソート対応を実装する
- [ ] 5.1 (P) 推しリストの人気順取得と認証必須の判定を実装する
  - popularはfavorite_count降順、同値は更新日時で解消する
  - 未対応ソートはpopularへフォールバックする
  - 未認証時はauth_requiredとして扱う
  - 50件単位のページング取得を行う
  - _Requirements: 2.2, 2.3, 2.6, 3.3, 3.7_

- [ ] 5.2 (P) 推しリスト一覧のソートUIと共通キーを統一する
  - 画面上で人気順の切替が可能であることを示す
  - sortOrderキーと表示名の意味を他ページと統一する
  - 未認証時はログイン必須フローへ誘導する
  - _Requirements: 3.3, 3.5, 3.6, 3.7_

- [ ] 6. テストでフィルタ/ソートの統一挙動を検証する
- [ ] 6.1 SortOrderPolicyと各データ取得のユニット検証を追加する
  - 未対応sortOrderのフォールバックと既定値popularを確認する
  - Weekday/WorkPage/OshiListの並び順ルールが要件通りであることを確認する
  - _Requirements: 1.7, 2.3, 2.4, 2.5, 2.6, 6.1_

- [ ] 6.2 ページ間のソート維持とフィルタ連動の統合検証を追加する
  - TopPageの曜日切替とソート維持の連動を確認する
  - WorkPageのURL同期とソート反映を確認する
  - _Requirements: 1.1, 1.2, 3.2, 3.4, 4.1, 4.2, 4.3_

- [ ] 6.3 主要シナリオのUI/E2E検証を追加する
  - TopPageの当日曜日既定表示と「すべて」選択時の100件制限を確認する
  - WorkPageのソート切替が一覧に反映されることを確認する
  - _Requirements: 1.5, 1.6, 3.4, 6.2, 6.3_
